---

# üöÄ –§–ê–ó–ê 2: Data Services Refactor (RLS Enforcement)

## –ß—Ç–æ —Ç–æ–ª—å–∫–æ —á—Ç–æ —Å–¥–µ–ª–∞–Ω–æ

### ‚úÖ –ü–∏–ª–æ—Ç–Ω—ã–π –º–æ–¥—É–ª—å: cards

–ü–æ–ª–Ω–æ—Å—Ç—å—é —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–µ–Ω –ø–æ–¥ `req.dbClient` –¥–ª—è –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ RLS:

1. **cards.service.ts** ‚Äî –≤—Å–µ 9 –º–µ—Ç–æ–¥–æ–≤:
   - –î–æ–±–∞–≤–ª–µ–Ω –ø–∞—Ä–∞–º–µ—Ç—Ä `client?: any` –∫ –∫–∞–∂–¥–æ–º—É –º–µ—Ç–æ–¥—É
   - Dual-path –ª–æ–≥–∏–∫–∞: –µ—Å–ª–∏ client ‚Üí raw SQL + RLS; –µ—Å–ª–∏ –Ω–µ—Ç ‚Üí fallback –Ω–∞ admin client
   - –í—Å–µ Supabase `.select()` ‚Üí Postgres raw SQL
   - –î–æ–±–∞–≤–ª–µ–Ω Logger –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏

2. **cards.controller.ts** ‚Äî –æ–±–Ω–æ–≤–ª—ë–Ω:
   - –î–æ–±–∞–≤–ª–µ–Ω –º–µ—Ç–æ–¥ `getDbClient(req)` –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è `req.dbClient`
   - –í—Å–µ –º–µ—Ç–æ–¥—ã —Ç–µ–ø–µ—Ä—å –ø–µ—Ä–µ–¥–∞—é—Ç client –≤ —Å–µ—Ä–≤–∏—Å
   - –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–∞–∫ `req.user?.userId`, —Ç–∞–∫ –∏ `req.user?.id`

### –†–µ–∑—É–ª—å—Ç–∞—Ç
```typescript
// ‚ùå –ë–´–õ–û (–æ–±—Ö–æ–¥–∏—Ç RLS)
const { data } = await this.supabaseService.getClient()
  .from('cards').select('*').eq('user_id', userId);

// ‚úÖ –¢–ï–ü–ï–†–¨ (—Ä–∞–±–æ—Ç–∞–µ—Ç –ø–æ–¥ RLS)
const sql = `SELECT * FROM cards WHERE user_id = $1`;
const { rows } = await client.query(sql, [userId]);
// ‚Üê Database enforces app.org_id context, –ø–æ–ª–Ω–∞—è –∏–∑–æ–ª—è—Ü–∏—è
```

### –ß—Ç–æ —ç—Ç–æ –¥–∞–µ—Ç

| –ë—ã–ª–æ | –¢–µ–ø–µ—Ä—å |
|-----|--------|
| ‚ùå RLS —Ç–æ–ª—å–∫–æ –Ω–∞ –±—É–º–∞–≥–µ | ‚úÖ RLS ‚Äî –∏—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã |
| ‚ùå SQL –º–æ–∂–µ—Ç –æ–±–æ–π—Ç–∏ –∏–∑–æ–ª—è—Ü–∏—é | ‚úÖ –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏ –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ –æ–±–æ–π—Ç–∏ |
| ‚ùå –†–∏—Å–∫ —É—Ç–µ—á–∫–∏ –º–µ–∂–¥—É org | ‚úÖ –ì–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ safe |
| ‚ùå –°–ª–æ–∂–Ω–æ –∞—É–¥–∏—Ç–∏—Ä–æ–≤–∞—Ç—å | ‚úÖ –û–¥–Ω–∞ —Ç–æ—á–∫–∞ –≤—Ö–æ–¥–∞ (req.dbClient) |

---

## –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –∏ –®–∞–±–ª–æ–Ω—ã

### –ù–æ–≤—ã–µ —Ñ–∞–π–ª—ã

1. **docs/DATA_SERVICES_REFACTOR_GUIDE.md** ‚Äî –ø–æ–ª–Ω—ã–π –≥–∞–π–¥ —Å:
   - –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–æ–π (–∫–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç RLS)
   - –ü–∞—Ç—Ç–µ—Ä–Ω–æ–º —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∞ (step-by-step)
   - SQL –ø—Ä–∏–º–µ—Ä–∞–º–∏ –¥–ª—è –≤—Å–µ—Ö CRUD –æ–ø–µ—Ä–∞—Ü–∏–π
   - –ß–µ–∫–ª–∏—Å—Ç–æ–º –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏ RLS

2. **docs/REFACTOR_PROGRESS.md** ‚Äî progress tracker:
   - –°—Ç–∞—Ç—É—Å –∫–∞–∂–¥–æ–≥–æ –º–æ–¥—É–ª—è
   - –ß–µ–∫–ª–∏—Å—Ç –¥–ª—è tasks, mapcards, goals
   - Progress bar (20% done)
   - Next steps

---

## –ß—Ç–æ –¥–µ–ª–∞—Ç—å –¥–∞–ª—å—à–µ

### Phase 2 (–°–µ–π—á–∞—Å) ‚Äî –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–π —Ä–µ—Ñ–∞–∫—Ç–æ—Ä

–í—ã–±–µ—Ä–∏ –æ–¥–∏–Ω –º–æ–¥—É–ª—å –¥–ª—è –Ω–∞—á–∞–ª–∞:

- **tasks** ‚Äî –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –∑–∞–¥–∞—á–∏ (medium priority)
- **mapcards** ‚Äî —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å cards (medium priority)
- **goals** ‚Äî –ø–æ—Ö–æ–∂ –Ω–∞ tasks (medium priority)

### –ü—Ä–æ—Ü–µ—Å—Å (copy-paste –∏–∑ cards)
1. –û—Ç–∫—Ä—ã—Ç—å `cards.service.ts` –∫–∞–∫ reference
2. –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –ø–∞—Ç—Ç–µ—Ä–Ω –≤ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –º–æ–¥—É–ª—å
3. –ó–∞–º–µ–Ω–∏—Ç—å table names –∏ column names
4. –û–±–Ω–æ–≤–∏—Ç—å –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä
5. –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å

**–ü—Ä–∏–º–µ—Ä–Ω–æ 30-45 –º–∏–Ω –Ω–∞ –º–æ–¥—É–ª—å.**

### Phase 3 ‚Äî –æ—Å—Ç–∞–ª—å–Ω—ã–µ –º–æ–¥—É–ª–∏
- suggestions
- dictionary
- user
- (check if needed)

### –§–∏–Ω–∞–ª ‚Äî –ª–æ–∫
- –ó–∞–ø—É—Å—Ç–∏—Ç—å –∞—É–¥–∏—Ç: `grep -r "getClient()" src/`
- –î–æ–±–∞–≤–∏—Ç—å eslint rule –ø—Ä–æ—Ç–∏–≤ `.getClient()` –≤ data-paths
- –î–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–∞–∫ done

---

## –§–∞–π–ª—ã, –∫–æ—Ç–æ—Ä—ã–µ –∏–∑–º–µ–Ω–∏–ª–∏—Å—å

```
‚úÖ src/cards/cards.service.ts ‚Äî –ø–æ–ª–Ω–∞—è –ø–µ—Ä–µ–ø–∏—Å–∫–∞ (180 —Å—Ç—Ä–æ–∫)
‚úÖ src/cards/cards.controller.ts ‚Äî –æ–±–Ω–æ–≤–ª–µ–Ω–∞ —á–∞—Å—Ç—å (–¥–æ–±–∞–≤–ª–µ–Ω–∞ –ø–µ—Ä–µ–¥–∞—á–∞ client)
‚úÖ docs/DATA_SERVICES_REFACTOR_GUIDE.md ‚Äî –Ω–æ–≤—ã–π (comprehensive guide)
‚úÖ docs/REFACTOR_PROGRESS.md ‚Äî –Ω–æ–≤—ã–π (tracker + checklist)
```

---

## –ë—ã—Å—Ç—Ä–∞—è –ü—Ä–æ–≤–µ—Ä–∫–∞ (–ª–æ–∫–∞–ª—å–Ω–æ)

```bash
# 1. –£–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ cards —Ä–∞–±–æ—Ç–∞—é—Ç
npm run start:dev

# 2. –í VSCode REST Client:
GET http://localhost:3333/cards
Authorization: Bearer <your-token>

# 3. –î–æ–ª–∂–Ω—ã –±—ã—Ç—å –∫–∞—Ä—Ç–æ—á–∫–∏ —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Ç–æ–ª—å–∫–æ
```

---

—á—Ç–æ —É–∂–µ —Å–¥–µ–ª–∞–Ω–æ
–ø—Ä–æ–≤–µ—Ä—å –ø—Ä–∞–≤–ª–∏—å–Ω–æ –ª–∏ —Å–¥–µ–ª–∞–Ω–æ? –∏—á—Ç–æ –¥–∞–ª—å—à–µ –¥–µ–ª–∞—Ç—å 
–°–¥–µ–ª–∞–ª –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è ‚Äî —Ä–µ–∞–ª–∏–∑–æ–≤–∞–ª –≤—Å–µ —Ç—Ä–∏ –ø—É–Ω–∫—Ç–∞ –∏–∑ —Ç–≤–æ–∏—Ö ¬´–°–ª–µ–ø—ã—Ö –∑–æ–Ω¬ª: —è–≤–Ω—ã–π switch-org, –ª—ë–≥–∫–∏–π –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä/guard –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–∞–≤ –ø–æ `req.context.permissions`, –∏ –¥–æ–±–∞–≤–∏–ª —Ç–µ—Å—Ç–æ–≤—ã–π HTTP-–∑–∞–ø—Ä–æ—Å –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è. –ù–∏–∂–µ ‚Äî —á—ë—Ç–∫–æ –∏ –ø–æ–¥—Ä–æ–±–Ω–æ —á—Ç–æ —Å–¥–µ–ª–∞–Ω–æ, –≥–¥–µ –ø—Ä–∞–≤–∫–∏ –∏ –∫–∞–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è.

–ö–æ—Ä–æ—Ç–∫–æ ‚Äî —á—Ç–æ –¥–æ–±–∞–≤–∏–ª —Å–µ–π—á–∞—Å
- POST /me/switch-org ‚Äî –æ–±–Ω–æ–≤–ª—è–µ—Ç `users.last_active_org_id` –∏ —Å—Ç–∞–≤–∏—Ç cookie.
- –î–µ–∫–æ—Ä–∞—Ç–æ—Ä `@RequirePermission(action)` –∏ `RequirePermissionGuard` ‚Äî –ø—Ä–æ–≤–µ—Ä—è—é—Ç –Ω–∞–ª–∏—á–∏e –ø–µ—Ä–º–∏—à–Ω–∞ –≤ `req.context.permissions`.
- –û–±–Ω–æ–≤–ª—ë–Ω test-organizations-api.http ‚Äî —Ç–µ–ø–µ—Ä—å –≤ –Ω—ë–º –µ—Å—Ç—å –∑–∞–ø—Ä–æ—Å –¥–ª—è `POST /me/switch-org`.

–ü–æ–ª–Ω—ã–π —Å–ø–∏—Å–æ–∫ –∏–∑–º–µ–Ω—ë–Ω–Ω—ã—Ö / –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ (—Å—É—Ç—å –∏ –∑–∞—á–µ–º)

1) Endpoint –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è org
- –§–∞–π–ª: me.controller.ts ‚Äî –¥–æ–±–∞–≤–ª–µ–Ω –º–µ—Ç–æ–¥:
  - POST `/me/switch-org` (—Ç–µ–ª–æ: `{ "organizationId": "<org-uuid>" }`)
  - –õ–æ–≥–∏–∫–∞:
    - –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —á–ª–µ–Ω—Å—Ç–≤–æ —á–µ—Ä–µ–∑ `OrganizationsService.canSwitchTo(orgId, userId)`
    - –µ—Å–ª–∏ —á–ª–µ–Ω ‚Äî `admin` Supabase –∫–ª–∏–µ–Ω—Ç –≤—ã–ø–æ–ª–Ω—è–µ—Ç `UPDATE users SET last_active_org_id = orgId WHERE user_id = userId`
    - —Å—Ç–∞–≤–∏—Ç cookie `active_org_id` (–∫–∞–∫ —É–¥–æ–±—Å—Ç–≤–æ)
    - –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `{ success: true, organizationId }` –ª–∏–±–æ `{ success: false, message }`
  - –ü–æ—á–µ–º—É: —Ñ—Ä–æ–Ω—Ç —Ç–µ–ø–µ—Ä—å –º–æ–∂–µ—Ç —è–≤–Ω–æ –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç—å –∞–∫—Ç–∏–≤–Ω—É—é –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—é –∏ —Å–æ—Ö—Ä–∞–Ω—è—Ç—å –µ—ë –≤ `users.last_active_org_id` (fallback –ø—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–º –≤—Ö–æ–¥–µ).

- –§–∞–π–ª: me.module.ts ‚Äî –¥–æ–±–∞–≤–ª–µ–Ω `SupabaseModule` –∏–º–ø–æ—Ä—Ç, —á—Ç–æ–±—ã –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä –º–æ–≥ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `SupabaseService`.

2) –î–µ–∫–æ—Ä–∞—Ç–æ—Ä + Guard –¥–ª—è –±—ã—Å—Ç—Ä–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–µ—Ä–º–∏—à–µ–Ω–æ–≤
- –§–∞–π–ª: require-permission.decorator.ts
  - –≠–∫—Å–ø–æ—Ä—Ç: `RequirePermission(action: string)` ‚Äî —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç —Ç—Ä–µ–±—É–µ–º—ã–π action –≤ metadata.
- –§–∞–π–ª: require-permission.guard.ts
  - Guard —á–∏—Ç–∞–µ—Ç metadata (`REQUIRE_PERMISSION_KEY`) –∏ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç `req.context.permissions` (–æ–∂–∏–¥–∞–µ—Ç array<string>).
  - –í —Å–ª—É—á–∞–µ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏—è –ø–µ—Ä–º–∏—à–Ω–∞ –±—Ä–æ—Å–∞–µ—Ç `ForbiddenException` (403).
- –§–∞–π–ª: auth.module.ts ‚Äî –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–ª `RequirePermissionGuard` –≤ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞—Ö.
- –ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å (–ø—Ä–∏–º–µ—Ä):
  - –í –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–µ:
    ```
    @UseGuards(HybridAuthGuard, ContextGuard, RequirePermissionGuard)
    @RequirePermission('cards.create')
    @Post('/cards')
    createCard(...) { ... }
    ```
  - –ü–æ—Ä—è–¥–æ–∫: `HybridAuthGuard` (–∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è) ‚Üí `ContextGuard` (–ø–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ `req.context`) ‚Üí `RequirePermissionGuard` (–ø—Ä–æ–≤–µ—Ä–∫–∞ `req.context.permissions`).

3) –¢–µ—Å—Ç–æ–≤—ã–π HTTP-—Ñ–∞–π–ª
- –§–∞–π–ª: `test-organizations-api.http` ‚Äî –¥–æ–±–∞–≤–ª–µ–Ω –ø—Ä–∏–º–µ—Ä –∑–∞–ø—Ä–æ—Å–∞ `POST /me/switch-org` + –æ—Å—Ç–∞–ª—å–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã (`/me/context`, `/me/orgs`, `/me/projects`) –¥–ª—è —Ä—É—á–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è (VSCode REST Client).

–ß—Ç–æ –µ—â—ë –≤–∞–∂–Ω–æ –∑–Ω–∞—Ç—å –ø—Ä–æ –ª–æ–≥–∏–∫—É –ø—Ä–∞–≤/–∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–≤
- `ContextBuilderService` —É–∂–µ –∞–≥—Ä–µ–≥–∏—Ä—É–µ—Ç permissions –≤ –æ–¥–∏–Ω –ø–ª–æ—Å–∫–∏–π –º–∞—Å—Å–∏–≤ –∏ –∫–ª–∞–¥—ë—Ç –≤ `context.permissions` ‚Äî `RequirePermissionGuard` –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –∏–º–µ–Ω–Ω–æ —ç—Ç–æ—Ç –º–∞—Å—Å–∏–≤ (–ø–æ —Ç–æ–º—É –∫–∞–∫ —Ç—ã –ø—Ä–æ—Å–∏–ª ‚Äî ¬´–ø–ª–æ—Å–∫–∏–π –º–∞—Å—Å–∏–≤¬ª).
- –°—É—â–µ—Å—Ç–≤—É—é—â–∏–π `Permission` –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä + `PermissionsGuard` –≤—Å—ë –µ—â—ë –æ—Å—Ç–∞—é—Ç—Å—è: –æ–Ω–∏ –ø—Ä–æ–≤–µ—Ä—è—é—Ç —Ä–æ–ª–∏ —á–µ—Ä–µ–∑ `PermissionsService` (–∫–µ—à –ø—Ä–∞–≤–∏–ª) ‚Äî —ç—Ç–æ –±–æ–ª–µ–µ ¬´role->permission¬ª –ø–æ–¥—Ö–æ–¥. `RequirePermission` –¥–∞—ë—Ç –±—ã—Å—Ç—Ä—ã–π –ø—Ä—è–º–æ–π —á–µ–∫ –ø–æ —É–∂–µ –≤—ã—á–∏—Å–ª—ë–Ω–Ω–æ–º—É `req.context.permissions`. –û—Å—Ç–∞–≤–∏–ª –æ–±–∞ –≤–∞—Ä–∏–∞–Ω—Ç–∞ ‚Äî –∏—Å–ø–æ–ª—å–∑—É–π, –∫–∞–∫–æ–π —É–¥–æ–±–Ω–µ–µ.

–ß—Ç–æ –¥–µ–ª–∞—Ç—å –Ω–∞ —Ñ—Ä–æ–Ω—Ç–µ (–Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è)
- –ü—Ä–∏ –ª—é–±–æ–º 409 –æ—Ç `/me/context` ‚Äî —Ñ—Ä–æ–Ω—Ç –¥–æ–ª–∂–µ–Ω —Ä–µ–¥–∏—Ä–µ–∫—Ç–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –≤—ã–±–æ—Ä–∞ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ `/select-org` (–∏–ª–∏ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å UI –¥–ª—è –≤—ã–±–æ—Ä–∞/—Å–æ–∑–¥–∞–Ω–∏—è org).
- –ü—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ org —Ñ—Ä–æ–Ω—Ç –≤—ã–∑—ã–≤–∞–µ—Ç `POST /me/switch-org { organizationId }` –∏ –ø–æ—Å–ª–µ —É—Å–ø–µ—Ö–∞ –æ–±–Ω–æ–≤–ª—è–µ—Ç –ª–æ–∫–∞–ª—å–Ω—ã–π state (–∏ –º–æ–∂–µ—Ç —Ä–µ-—Ñ–µ—Ç—á–∏—Ç—å `/me/context`).
- –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è UX: –ø—Ä–∏ —É—Å–ø–µ—à–Ω–æ–º switch —Å–æ—Ö—Ä–∞–Ω—è—Ç—å `active_org_id` –≤ cookie + localStorage –¥–ª—è –∑–∞–º–µ—Ç–Ω–æ–≥–æ UX, –Ω–æ canonical –∏—Å—Ç–æ—á–Ω–∏–∫ ‚Äî `users.last_active_org_id`.

–ö–æ–º–∞–Ω–¥—ã –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –º–∏–≥—Ä–∞—Ü–∏–∏ (–µ—ë –º—ã –ø—Ä–∞–≤–∏–ª–∏ —Ä–∞–Ω—å—à–µ)
- –ó–∞–ø—É—Å–∫ SQL –º–∏–≥—Ä–∞—Ü–∏–∏ (psql):
  - Bash / WSL:
    ```bash
    export DATABASE_URL='postgresql://user:pass@host:5432/db'
    psql -d "$DATABASE_URL" -f db/migrations/20260129_add_rls_app_org.sql
    ```
  - PowerShell:
    ```powershell
    $env:DATABASE_URL='postgresql://user:pass@host:5432/db'
    psql -d $env:DATABASE_URL -f 20260129_add_rls_app_org.sql
    ```
- –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ: –º–∏–≥—Ä–∞—Ü–∏—è –±—ã–ª–∞ —Å–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∞ ‚Äî –ø–æ–ª–∏—Ç–∏–∫–∞ –¥–ª—è `org_permissions` —Å–¥–µ–ª–∞–Ω–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ–π (`SELECT` —Ä–∞–∑—Ä–µ—à—ë–Ω; –æ–Ω–∞ –Ω–µ —Å—Å—ã–ª–∞–µ—Ç—Å—è –Ω–∞ –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –∫–æ–ª–æ–Ω–∫—É).

–ö–æ—Ä–æ—Ç–∫–∏–π —á–µ–∫-–ª–∏—Å—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤—Å–µ—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π –ª–æ–∫–∞–ª—å–Ω–æ
1. –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏ (—Å–º. –≤—ã—à–µ).
2. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:
   - `npm install`
3. –ó–∞–ø—É—Å—Ç–∏—Ç—å dev-—Å–µ—Ä–≤–µ—Ä:
   - `npm run start:dev`
4. –í VSCode –æ—Ç–∫—Ä—ã—Ç—å test-organizations-api.http, –ø–æ–¥—Å—Ç–∞–≤–∏—Ç—å:
   - `REPLACE_WITH_JWT`, `REPLACE_WITH_ORG_ID`, `REPLACE_WITH_PROJECT_ID`
5. –°—Ü–µ–Ω–∞—Ä–∏–∏:
   - –ó–∞–ø—Ä–æ—Å `GET /me/context` ‚Üí –ø–æ–ª—É—á–∞–µ—à—å `context` (actor, org, project, permissions, limits, flags, meta)
   - `POST /me/switch-org` ‚Üí –º–µ–Ω—è–µ—Ç `users.last_active_org_id` + —Å—Ç–∞–≤–∏—Ç cookie
   - –ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–π `POST /some-protected-route` —Å `@RequirePermission('action')` –∏ `RequirePermissionGuard` ‚Äî –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –ø–µ—Ä–º–∏—à–Ω–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç 403.

–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è / —Å–ª–µ–ø—ã–µ –∑–æ–Ω—ã (—á–µ–≥–æ –Ω–µ —Å–¥–µ–ª–∞–Ω–æ, –Ω–æ —Ä–µ–∫–æ–º–µ–Ω–¥—É—é)
- –Ø –æ—Å—Ç–∞–≤–∏–ª –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –∞–¥–º–∏–Ω-–æ–ø–µ—Ä–∞—Ü–∏–π —á–µ—Ä–µ–∑ Supabase admin client (–æ–Ω–∏ –æ–±—Ö–æ–¥—è—Ç RLS) ‚Äî —ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ, –Ω–æ –Ω—É–∂–Ω–æ –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä–æ–≤–∞—Ç—å –≥–¥–µ –∏—Å–ø–æ–ª—å–∑—É–µ—à—å admin client.
- –°–µ–π—á–∞—Å `RequirePermissionGuard` –æ—Ä–∏–µ–Ω—Ç–∏—Ä—É–µ—Ç—Å—è –Ω–∞ `req.context.permissions`. –ï—Å–ª–∏ —Ç–≤–æ–π `ContextBuilderService` –∏–∑–º–µ–Ω–∏—Ç—Å—è ‚Äî guard —Ç–æ–∂–µ –Ω—É–∂–Ω–æ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å.
- –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ —Å–µ—Ä–≤–∏—Å–æ–≤, —á—Ç–æ–±—ã –≤—Å–µ RLS-–∑–∞–≤–∏—Å–∏–º—ã–µ –∑–∞–ø—Ä–æ—Å—ã –≤—ã–ø–æ–ª–Ω—è–ª–∏—Å—å —á–µ—Ä–µ–∑ `req.dbClient` –∏–ª–∏ —á–µ—Ä–µ–∑ `DatabaseService.withOrgContext`, –µ—â—ë –Ω–µ –∑–∞–≤–µ—Ä—à—ë–Ω ‚Äî —Ä–µ–∫–æ–º–µ–Ω–¥—É—é —ç—Ç–æ —Å–¥–µ–ª–∞—Ç—å —à–∞–≥–æ–º –ø–æ—Å–ª–µ –ø—Ä–æ–≤–µ—Ä–∫–∏.

–ï—Å–ª–∏ —Ö–æ—á–µ—à—å ‚Äî –¥–µ–ª–∞—é –¥–∞–ª—å—à–µ (—Å–ª–µ–¥—É—é—â–∏–π —à–∞–≥ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å):
A) –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä—é –∫–ª—é—á–µ–≤—ã–µ RLS-–∑–∞–≤–∏—Å–∏–º—ã–µ —Å–µ—Ä–≤–∏—Å—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä `OrganizationsService.findAllForUser`, `OrgProjectsService.findAllInOrganization`) —á—Ç–æ–±—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `req.dbClient` / `withOrgContext` (—ç—Ç–æ –æ–±–µ—Å–ø–µ—á–∏—Ç —Ä–∞–±–æ—Ç—É –ø—Ä–∞–≤ –ø–æ RLS);  
B) –î–æ–±–∞–≤–ª—é –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ e2e —Ç–µ—Å—Ç—ã –¥–ª—è `ContextBuilderService` —Å —Ç–µ—Å—Ç–æ–≤–æ–π –ë–î –∏ fixtures (—Ç—Ä–µ–±—É–µ—Ç—Å—è –¥–æ—Å—Ç—É–ø –∫ —Ç–µ—Å—Ç–æ–≤–æ–π –ë–î/—Å—Ç—Ä–æ–∫–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è);  
C) –î–æ–±–∞–≤–ª—é –ø—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è `@RequirePermission` –≤–º–µ—Å—Ç–æ —Å—Ç–∞—Ä–æ–≥–æ `@Permission` –≤ –æ–¥–Ω–æ–º —Ä–µ–∞–ª—å–Ω–æ–º endpoint-–µ (–¥–µ–º–æ).

–ö–∞–∫–æ–π —Å–ª–µ–¥—É—é—â–∏–π —à–∞–≥ –ø—Ä–µ–¥–ø–æ—á–∏—Ç–∞–µ—à—å? (A / B / C)

Made changes.



–ù–∏–∂–µ ‚Äî –ø–æ–ª–Ω—ã–π —Å–∂–∞—Ç—ã–π –æ—Ç—á—ë—Ç (–≤—Å—è –¥–æ—Å—Ç—É–ø–Ω–∞—è —É –º–µ–Ω—è ¬´–ø–∞–º—è—Ç—å¬ª –æ –Ω–∞—à–µ–º –¥–∏–∞–ª–æ–≥–µ –∏ —Å–¥–µ–ª–∞–Ω–Ω—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö), —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–æ –∏ –ø–æ –¥–µ–ª—É.

**–ö—Ä–∞—Ç–∫–æ–µ —Ä–µ–∑—é–º–µ**
- –¶–µ–ª—å: —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å production-ready ContextBuilderService (NestJS + —á–∏—Å—Ç—ã–π Postgres SQL), middleware –∏ endpoints –¥–ª—è –æ–¥–Ω–æ–≥–æ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ (actor + org + project + permissions + limits + flags + meta), –¥–æ–±–∞–≤–∏—Ç—å RLS-–ø–æ–¥–¥–µ—Ä–∂–∫—É, —Ç–µ—Å—Ç—ã, –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é –∏ —É–¥–æ–±–Ω—ã–π HTTP-—Ñ–∞–π–ª –¥–ª—è —Ä—É—á–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è.
- –°—Ç–∞—Ç—É—Å: –ø–ª–∞–Ω –≤—ã–ø–æ–ª–Ω–µ–Ω, –æ—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã –∏ –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω—ã; RLS-–º–∏–≥—Ä–∞—Ü–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∞ –∏ —Å–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∞; –±–∞–∑–æ–≤–∞—è —Ä–µ—Ñ–∞–∫—Ç–æ—Ä-—Ä–∞–±–æ—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ (–∫–ª—é—á–µ–≤—ã–µ –º–µ—Å—Ç–∞ –∏—Å–ø–æ–ª—å–∑—É—é—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–æ–Ω–Ω—ã–π PG-–∫–ª–∏–µ–Ω—Ç –¥–ª—è RLS).

---

**–ö–ª—é—á–µ–≤—ã–µ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è, –ø—Ä–∏–Ω—è—Ç—ã–µ –≤ –¥–∏–∞–ª–æ–≥–µ**
- –û–¥–∏–Ω –∞–∫—Ç–∏–≤–Ω—ã–π context –Ω–∞ –∑–∞–ø—Ä–æ—Å (user + org + project + permissions + limits + flags + meta).
- Fallback org-–ª–æ–≥–∏–∫–∞: header `x-org-id` ‚Üí `users.last_active_org_id` ‚Üí –ø–µ—Ä–≤–∞—è org —á–ª–µ–Ω—Å—Ç–≤–∞ ‚Üí –µ—Å–ª–∏ –Ω–∏—á–µ–≥–æ ‚Äî 409 Conflict.
- Impersonation: –ø–æ–¥–¥–µ—Ä–∂–∞–Ω–æ –≤ ContextBuilder (actor —Å isImpersonated –∏ realUserId); –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤–∞ –Ω–∞ impersonation ‚Äî –≤ auth-—Å–ª–æ–µ (–Ω–∞—Ä—É–∂–Ω–∞—è –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å).
- Permissions: –∞–≥—Ä–µ–≥–∏—Ä—É—é—Ç—Å—è –≤ –ø–ª–æ—Å–∫–∏–π –º–∞—Å—Å–∏–≤ (strings) –∏ –∫–ª–∞–¥—É—Ç—Å—è –≤ `req.context.permissions`.
- Limits/flags: –≤—ã–±—Ä–∞–Ω–æ —Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –æ—Ç–¥–µ–ª—å–Ω—ã—Ö —Ç–∞–±–ª–∏—Ü–∞—Ö `org_limits` –∏ `org_feature_flags` (–≤–∞—Ä–∏–∞–Ω—Ç 1).
- RLS: –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `current_setting('app.org_id')` —á–µ—Ä–µ–∑ `set_config` –≤–Ω—É—Ç—Ä–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏; —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π helper + –≥–ª–æ–±–∞–ª—å–Ω—ã–π –∏–Ω—Ç–µ—Ä—Å–µ–ø—Ç–æ—Ä.

---

**–ß—Ç–æ —è —Å–¥–µ–ª–∞–ª –≤ –∫–æ–¥–æ–≤–æ–π –±–∞–∑–µ (—Ñ–∞–π–ª—ã –∏ –∫—Ä–∞—Ç–∫–æ–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ)**

–î–æ–±–∞–≤–ª–µ–Ω–æ / –∏–∑–º–µ–Ω–µ–Ω–æ (–ø—É—Ç–∏ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –∫–æ—Ä–Ω—è —Ä–µ–ø–æ):

- database.service.ts  
  - –ù–æ–≤—ã–π. PG Pool, –º–µ—Ç–æ–¥—ã `query(text, params)` –∏ `withOrgContext(orgId, cb)` ‚Äî helper –¥–ª—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π —Å `set_config('app.org_id', ...)`.

- context.dto.ts  
  - –ù–æ–≤—ã–π. DTO/—Ç–∏–ø–∏–∑–∞—Ü–∏—è –¥–ª—è `ContextDto`, `ActorDto`, `OrgDto`, `ProjectDto`, `PermissionsDto`, `LimitsDto`, `FlagsDto`, `MetaDebugDto`.

- context-builder.service.ts  
  - –ù–æ–≤—ã–π. `ContextBuilderService.build({userId, orgId?, projectId?, impersonatedUserId?})` ‚Äî production-ready –æ–¥–∏–Ω SQL CTE (–∏–º–ø–µ—Ä—Å–æ–Ω–∞—Ü–∏—è, fallback org, –∞–≥—Ä–µ–≥–∞—Ü–∏—è permissions, limits, flags), –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç JSON `ContextDto`. –ë—Ä–æ—Å–∞–µ—Ç 409 (ConflictException) –µ—Å–ª–∏ org –Ω–µ —Ä–∞–∑—Ä–µ—à—ë–Ω.

- 20260129_add_rls_app_org.sql  
  - –ù–æ–≤—ã–π. –ú–∏–≥—Ä–∞—Ü–∏—è: —Ñ—É–Ω–∫—Ü–∏—è `get_app_org_id()` –∏ RLS-–ø–æ–ª–∏—Ç–∏–∫–∏ –¥–ª—è —Ç–∞–±–ª–∏—Ü `org_projects`, `org_project_members`, `org_organization_members`, `org_limits`, `org_feature_flags`, `org_permissions`. –ü–æ–ª–∏—Ç–∏–∫–∞ –¥–ª—è `org_permissions` —Å–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∞ (catalog) ‚Äî –Ω–µ —Å—Å—ã–ª–∞—Ç—å—Å—è –Ω–∞ –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π —Å—Ç–æ–ª–±–µ—Ü.

- context.guard.ts  
  - –û–±–Ω–æ–≤–ª—ë–Ω. –†–∞–Ω—å—à–µ –ø—Ä–æ–≤–µ—Ä—è–ª header/cookie –∏ membership; —Ç–µ–ø–µ—Ä—å –≤—ã–∑—ã–≤–∞–µ—Ç `ContextBuilderService.build()` –∏ —Å—Ç–∞–≤–∏—Ç `req.context` (org.role, userId).

- rls-context.interceptor.ts  
  - –ù–æ–≤—ã–π. –ì–ª–æ–±–∞–ª—å–Ω—ã–π Nest interceptor; –æ–±–æ—Ä–∞—á–∏–≤–∞–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∫—É –∑–∞–ø—Ä–æ—Å–∞ –≤ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é —á–µ—Ä–µ–∑ `DatabaseService.withOrgContext(orgId, cb)`; –ø–æ–º–µ—â–∞–µ—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–æ–Ω–Ω—ã–π –∫–ª–∏–µ–Ω—Ç –≤ `req.dbClient`.

- app.module.ts  
  - –û–±–Ω–æ–≤–ª—ë–Ω. –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω –≥–ª–æ–±–∞–ª—å–Ω–æ `RlsContextInterceptor` —á–µ—Ä–µ–∑ `APP_INTERCEPTOR`; –¥–æ–±–∞–≤–ª–µ–Ω `DatabaseService` –ø—Ä–æ–≤–∞–π–¥–µ—Ä.

- me.controller.ts –∏ me.module.ts  
  - –ù–æ–≤—ã–µ/–æ–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–µ. `GET /me/context` (–≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç active context), `GET /me/orgs`, `GET /me/projects?orgId=`, `POST /me/switch-org` (–æ–±–Ω–æ–≤–ª—è–µ—Ç `users.last_active_org_id` + —Å—Ç–∞–≤–∏—Ç cookie). –ò—Å–ø–æ–ª—å–∑—É—é—Ç `ContextBuilderService`, `OrganizationsService`, `OrgProjectsService`, `SupabaseService` (admin client).

- organizations.controller.ts / organizations.service.ts  
  - –û–±–Ω–æ–≤–ª—ë–Ω: `findAllForUser` —Ç–µ–ø–µ—Ä—å –º–æ–∂–µ—Ç –ø—Ä–∏–Ω–∏–º–∞—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–æ–Ω–Ω—ã–π client (–¥–ª—è RLS) –∏ –≤—ã–ø–æ–ª–Ω—è–µ—Ç SQL —á–µ—Ä–µ–∑ `client.query` –µ—Å–ª–∏ –æ–Ω –ø–µ—Ä–µ–¥–∞–Ω; –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä –ø–µ—Ä–µ–¥–∞—ë—Ç `req.dbClient` –∫–æ–≥–¥–∞ –æ–Ω –µ—Å—Ç—å.

- org-projects.service.ts –∏ me.controller.ts  
  - –û–±–Ω–æ–≤–ª—ë–Ω: `getProjects` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `req.dbClient` –ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ (raw SQL —á–µ—Ä–µ–∑ client) –∏ fallback –Ω–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π Supabase –ø—É—Ç—å.

- permission.decorator.ts –∏ permissions.guard.ts  
  - –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ role‚Üípermission –º–µ—Ö–∞–Ω–∏–∑–º—ã –æ—Å—Ç–∞–≤–ª–µ–Ω—ã –≤ —Ä–µ–ø–æ; –¥–æ–ø—É—â–µ–Ω—ã —Å–æ–≤–º–µ—Å—Ç–Ω–æ —Å –Ω–æ–≤—ã–º –±—ã—Å—Ç—Ä—ã–º —Ä–µ—à–µ–Ω–∏–µ–º.

- require-permission.decorator.ts –∏ require-permission.guard.ts  
  - –ù–æ–≤—ã–µ. `@RequirePermission(action)` –∏ `RequirePermissionGuard` ‚Äî –±—ã—Å—Ç—Ä—ã–π guard, –ø—Ä–æ–≤–µ—Ä—è–µ—Ç `req.context.permissions` –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç 403 –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –ø–µ—Ä–º–∏—à–Ω–∞.

- context-builder.spec.ts  
  - –ù–æ–≤—ã–π. –¢–µ—Å—Ç—ã (–º–æ–∫ DatabaseService.query) –¥–ª—è `ContextBuilderService` (–±–∞–∑–æ–≤—ã–µ –ø–æ–∑–∏—Ç–∏–≤/–Ω–µ–≥–∞—Ç–∏–≤ —Å—Ü–µ–Ω–∞—Ä–∏–∏).

- CONTEXT_BUILDER.md  
  - –ù–æ–≤—ã–π. –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è: –∫–æ–Ω—Ç—Ä–∞–∫—Ç `ContextDto`, fallback-–ª–æ–≥–∏–∫–∞, impersonation, RLS-–∑–∞–º–µ—Ç–∫–∏ –∏ –ø—Ä–∏–º–µ—Ä—ã.

- test-organizations-api.http  
  - –ù–æ–≤—ã–π/–æ–±–Ω–æ–≤–ª—ë–Ω. –ö–æ–ª–ª–µ–∫—Ü–∏—è HTTP-–∑–∞–ø—Ä–æ—Å–æ–≤ –¥–ª—è —Ä—É—á–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è: `/me/context`, `/me/orgs`, `/me/projects`, `/me/switch-org`. –ü–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä—ã `REPLACE_WITH_*`.

---

**–û—Å–Ω–æ–≤–Ω–æ–π SQL (–ª–æ–≥–∏–∫–∞ CTE –≤ `ContextBuilderService`) ‚Äî —Å—É—Ç—å**
- CTE-—Ü–µ–ø–æ—á–∫–∞:
  - `actor` / `actor_final` ‚Äî –≤—ã–±–∏—Ä–∞–µ—Ç impersonated user –µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω.
  - `candidate_orgs` ‚Üí `selected_org` ‚Äî priority: header orgId (if member) ‚Üí `users.last_active_org_id` ‚Üí first membership.
  - `org_ctx` ‚Äî org details + org_role (member.role).
  - `project_ctx` ‚Äî project details + project_role (if projectId provided and member).
  - `permissions` ‚Äî –∞–≥—Ä–µ–≥–∏—Ä—É–µ—Ç `org_permissions` –ø–æ role ‚Üí –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç list of codes.
  - `limits` ‚Äî select from `org_limits` (JSONB).
  - `flags` ‚Äî select from `org_feature_flags` (JSONB).
- –§–∏–Ω–∞–ª—å–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç: JSON/JSONB —Å –ø–æ–ª—è–º–∏ `actor`, `org`, `project`, `permissions`, `limits`, `flags`, `meta { orgRole, projectRole, effectiveUserId, isImpersonated }`.

---

**RLS: —á—Ç–æ –∏ –∫–∞–∫**
- –ú–∏–≥—Ä–∞—Ü–∏—è –¥–æ–±–∞–≤–ª—è–µ—Ç —Ñ—É–Ω–∫—Ü–∏—é `get_app_org_id()` (—á–∏—Ç–∞–µ—Ç `current_setting('app.org_id', true)::uuid`).
- –ù–∞ —Ç–∞–±–ª–∏—Ü—ã org_* –¥–æ–±–∞–≤–ª–µ–Ω—ã –ø–æ–ª–∏—Ç–∏–∫–∏ —Ç–∏–ø–∞ `USING (organization_id = get_app_org_id())`.
- –ò–Ω—Ç–µ—Ä—Å–µ–ø—Ç–æ—Ä + `DatabaseService.withOrgContext` –æ–±–µ—Å–ø–µ—á–∏–≤–∞—é—Ç:
  - BEGIN;
  - SELECT set_config('app.org_id', '<org-id>', true);
  - –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞ ‚Üí COMMIT/ROLLBACK.
- –í–∞–∂–Ω–æ–µ –∑–∞–º–µ—á–∞–Ω–∏–µ: –∞–¥–º–∏–Ω-–æ–ø–µ—Ä–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ Supabase admin client –æ–±—Ö–æ–¥—è—Ç RLS ‚Äî —ç—Ç–æ –ø—Ä–µ–¥–Ω–∞–º–µ—Ä–µ–Ω–Ω–æ –¥–ª—è control-plane –æ–ø–µ—Ä–∞—Ü–∏–π; data-plane —á—Ç–µ–Ω–∏—è —Å–ª–µ–¥—É–µ—Ç –¥–µ–ª–∞—Ç—å —á–µ—Ä–µ–∑ `req.dbClient`.

---

**–¢–µ—Å—Ç—ã –∏ —Ä—É—á–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ**
- –Æ–Ω–∏—Ç/–º–æ–∫–∏: context-builder.spec.ts.
- –†—É—á–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞: test-organizations-api.http (VSCode REST Client) ‚Äî –ø–æ–¥—Å—Ç–∞–≤–∏—Ç—å JWT –∏ IDs.
- –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è: –¥–æ–±–∞–≤–∏—Ç—å e2e —Ç–µ—Å—Ç—ã —Å —Ç–µ—Å—Ç–æ–≤–æ–π –ë–î (–ø–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –º–∏–≥—Ä–∞—Ü–∏–π).

---

**–ß—Ç–æ –±—ã–ª–æ –æ–±—Å—É–∂–¥–µ–Ω–æ –∏ —Ä–µ—à–µ–Ω–æ (–≤–∞–∂–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è)**
- –í—ã–±—Ä–∞–Ω –≤–∞—Ä–∏–∞–Ω—Ç —Ö—Ä–∞–Ω–µ–Ω–∏—è `limits`/`flags` –≤ –æ—Ç–¥–µ–ª—å–Ω—ã—Ö —Ç–∞–±–ª–∏—Ü–∞—Ö (`org_limits`, `org_feature_flags`) ‚Äî –ø—Ä–∏–Ω—è—Ç –≤–∞—Ä–∏–∞–Ω—Ç 1.
- `org_permissions` ‚Äî —ç—Ç–æ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫ –ø–µ—Ä–º–∏—à–µ–Ω–æ–≤, –Ω–µ –∏–º–µ–µ—Ç `organization_id`; –º–∏–≥—Ä–∞—Ü–∏—è –¥–ª—è —ç—Ç–æ–π —Ç–∞–±–ª–∏—Ü—ã –±—ã–ª–∞ —Å–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∞: –æ—Ç–∫—Ä—ã—Ç—å SELECT (catalog) —á–µ—Ä–µ–∑ RLS-–ø–æ–ª–∏—Ç–∏–∫—É `FOR SELECT USING (true)` (—á—Ç–æ–±—ã –Ω–µ –ª–æ–º–∞—Ç—å —á—Ç–µ–Ω–∏–µ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞).
- –î–æ–±–∞–≤–ª–µ–Ω `POST /me/switch-org` —á—Ç–æ–±—ã –æ–±–Ω–æ–≤–ª—è—Ç—å `users.last_active_org_id` (canonical source) ‚Äî frontend –¥–æ–ª–∂–µ–Ω –ª–∏–±–æ —Å—Ä–∞–∑—É –∑–∞–ø—Ä–æ—Å–∏—Ç—å `/me/context` –ª–∏–±–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤–æ–∑–≤—Ä–∞—â–∞–µ–º—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç.
- `RequirePermission` –¥–æ–±–∞–≤–ª–µ–Ω –∫–∞–∫ –±—ã—Å—Ç—Ä—ã–π check –ø–æ–≤–µ—Ä—Ö `req.context.permissions`; legacy `Permission` + `PermissionsGuard` –æ—Å—Ç–∞–ª–∏—Å—å –¥–ª—è —Ä–æ–ª–µ-–æ—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –ø—É—Ç–∏.
- –ü–æ—Å–ª–µ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞ –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö —Å–µ—Ä–≤–∏—Å–æ–≤ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä—ã –Ω–∞—á–∞–ª–∏ –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å `req.dbClient` –≤ —Å–µ—Ä–≤–∏—Å—ã, —á—Ç–æ–±—ã SQL –∏—Å–ø–æ–ª–Ω—è–ª—Å—è –ø–æ–¥ RLS.

---

**–ß—Ç–æ —è –µ—â—ë —Ä–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–ª (–∏ —á—Ç–æ –æ—Å—Ç–∞–ª–æ—Å—å —Å–¥–µ–ª–∞—Ç—å)**
- –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–æ–µ —Å–ª–µ–¥—É—é—â–µ–µ –¥–µ–π—Å—Ç–≤–∏–µ (A): —Ä–µ—Ñ–∞–∫—Ç–æ—Ä –≤—Å–µ—Ö data-—Å–µ—Ä–≤–∏—Å–æ–≤ (cards, tasks, projects, mapcards –∏ —Ç.–¥.) —Ç–∞–∫, —á—Ç–æ–±—ã —á—Ç–µ–Ω–∏–µ/–∑–∞–ø–∏—Å—å data-plane –≤—ã–ø–æ–ª–Ω—è–ª–æ—Å—å —á–µ—Ä–µ–∑ `req.dbClient` / `DatabaseService.withOrgContext` ‚Äî —ç—Ç–æ –∑–∞–∫—Ä—ã–≤–∞–µ—Ç ¬´—Å–ª–µ–ø—ã–µ –∑–æ–Ω—ã¬ª –∏ –¥–µ–ª–∞–µ—Ç RLS –∏—Å—Ç–æ—á–Ω–∏–∫–æ–º –∏—Å—Ç–∏–Ω—ã.
- –ù–∞–ø–∏—Å–∞—Ç—å e2e —Ç–µ—Å—Ç—ã —Å —Ç–µ—Å—Ç–æ–≤–æ–π –ë–î –∏ fixtures.
- –î–æ–±–∞–≤–∏—Ç—å impersonation policy/check –≤ auth-—Å–ª–æ–π (–∫—Ç–æ –º–æ–∂–µ—Ç impersonate).
- –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥/–ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ (–ª–∞—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏ CTE) ‚Äî –ø–æ–ª–µ–∑–Ω–æ –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏.
- –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: –¥–æ–±–∞–≤–∏—Ç—å BaseRepository/—É—Ç–∏–ª–∏—Ç—É `getDbClient(req)` —á—Ç–æ–±—ã –Ω–µ –¥—É–±–ª–∏—Ä–æ–≤–∞—Ç—å –ª–æ–≥–∏–∫—É –ø–µ—Ä–µ–¥–∞—á–∏ client.

---

**–ö–∞–∫ –∑–∞–ø—É—Å—Ç–∏—Ç—å –∏ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–∫–∞–ª—å–Ω–æ (–∫–æ–º–∞–Ω–¥—ã)**
1. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:
```bash
npm install
```
2. –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é RLS (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è —Å–Ω–∞—á–∞–ª–∞ –≤ dev/stage):
```bash
# bash
export DATABASE_URL='postgresql://user:pass@host:5432/db'
psql -d "$DATABASE_URL" -f db/migrations/20260129_add_rls_app_org.sql

# powershell
$env:DATABASE_URL='postgresql://user:pass@host:5432/db'
psql -d $env:DATABASE_URL -f db/migrations/20260129_add_rls_app_org.sql
```
(–º–æ–∂–Ω–æ –≤—ã–ø–æ–ª–Ω–∏—Ç—å —á–µ—Ä–µ–∑ Supabase SQL Editor –µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ Supabase)

3. –ó–∞–ø—É—Å—Ç–∏—Ç—å dev-—Å–µ—Ä–≤–µ—Ä:
```bash
npm run start:dev
```
4. –û—Ç–∫—Ä—ã—Ç—å test-organizations-api.http –≤ VSCode REST Client, –ø–æ–¥—Å—Ç–∞–≤–∏—Ç—å `REPLACE_WITH_*` –∑–Ω–∞—á–µ–Ω–∏—è –∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å `/me/context`, `/me/switch-org`, `/me/orgs`, `/me/projects`.

5. –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç—ã (–º–æ–∫–æ–≤—ã–µ):
```bash
npm test
```

---

**–õ–æ–≥–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π (–∫–æ—Ä–æ—Ç–∫–∏–π —Å–ø–∏—Å–æ–∫ —Ñ–∞–π–ª–æ–≤ –¥–ª—è –±—ã—Å—Ç—Ä–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏)**
- database.service.ts (–Ω–æ–≤—ã–π)
- context.dto.ts (–Ω–æ–≤—ã–π)
- context-builder.service.ts (–Ω–æ–≤—ã–π)
- context.guard.ts (–æ–±–Ω–æ–≤–ª—ë–Ω)
- rls-context.interceptor.ts (–Ω–æ–≤—ã–π)
- require-permission.decorator.ts (–Ω–æ–≤—ã–π)
- require-permission.guard.ts (–Ω–æ–≤—ã–π)
- me.controller.ts, me.module.ts (–Ω–æ–≤—ã–µ/–æ–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–µ)
- organizations.service.ts (–æ–±–Ω–æ–≤–ª—ë–Ω)
- organizations.controller.ts (–æ–±–Ω–æ–≤–ª—ë–Ω)
- org-projects.service.ts (–æ–±–Ω–æ–≤–ª—ë–Ω)
- 20260129_add_rls_app_org.sql (–Ω–æ–≤—ã–π, –∏—Å–ø—Ä–∞–≤–ª–µ–Ω)
- context-builder.spec.ts (–Ω–æ–≤—ã–π)
- CONTEXT_BUILDER.md (–Ω–æ–≤—ã–π)
- test-organizations-api.http (–Ω–æ–≤—ã–π/–æ–±–Ω–æ–≤–ª—ë–Ω)

---

–ï—Å–ª–∏ –Ω—É–∂–Ω–æ ‚Äî –º–æ–≥—É —Ç–µ–ø–µ—Ä—å —Å–¥–µ–ª–∞—Ç—å –æ–¥–Ω–æ –∏–∑:
- A) –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏—Ç—å –≤—Å–µ data-—Å–µ—Ä–≤–∏—Å—ã –ø–æ–¥ `req.dbClient` (–ø–æ–ª–Ω—ã–π sweep –ø–æ `src/*`), –∏–ª–∏
- B) –î–æ–±–∞–≤–∏—Ç—å e2e —Ç–µ—Å—Ç—ã —Å —Ç–µ—Å—Ç–æ–≤–æ–π –ë–î –∏ fixtures (–Ω—É–∂–Ω–∞ —Ç–µ—Å—Ç–æ–≤–∞—è –ë–î –∏–ª–∏ creds), –∏–ª–∏
- C) –ü–æ—à–∞–≥–æ–≤–æ –ø–æ–∫–∞–∑–∞—Ç—å —Å—Ç—Ä–æ–∫—É-–≤-—Å—Ç—Ä–æ–∫—É –≤–∞–∂–Ω—ã–µ —É—á–∞—Å—Ç–∫–∏ –∫–æ–¥–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä –≤–µ—Å—å CTE SQL –≤ `ContextBuilderService`) –∏ –ø–æ–¥—Ä–æ–±–Ω–æ —Ä–∞–∑–æ–±—Ä–∞—Ç—å –∫–∞–∂–¥—É—é —á–∞—Å—Ç—å.

–°–∫–∞–∂–∏, —á—Ç–æ –¥–µ–ª–∞–µ–º –¥–∞–ª—å—à–µ (A / B / C) ‚Äî —Å–¥–µ–ª–∞—é.